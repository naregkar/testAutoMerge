name: 'ManageJiraPR'
on:
  pull_request:
    branches: 
      - master
  #pull_request_review:
  #  branches:
  #    - master
  #  types: [submitted]
  workflow_dispatch:
    types: ManageJira
env:
  GITHUB_PR_TITLE: ${{github.event.pull_request.title}}
  GITHUB_WORKFLOW_ID : ${{github.run_id}}
 
 
jobs:
  read-jira-status:
    runs-on: ubuntu-latest
    
    steps:
    
    - name: Display Run ID
      run: echo $GITHUB_WORKFLOW_ID
    
    - name: Get Jira Issue ID
      run: |
            echo "$GITHUB_PR_TITLE"
            JiraIdUnparsed=$GITHUB_PR_TITLE
            JiraId=${JiraIdUnparsed%]*}
            JiraId=${JiraId:1}
            echo "jira_id=$JiraId" >> $GITHUB_ENV
    
    - name: Read Jira Issue Status
      id: retrieveJiraStatus
      run: |
            restApiGET=$(curl --request GET \
                  --url 'https://naregkar.atlassian.net/rest/api/3/issue/${{ env.jira_id }}/' \
                  --user 'nareg.karamanoukian@picsart.com:oBJTrxuI3qf0Do1MBpGbBE87' \
                  --header 'Accept: application/json' | jq '.fields.status.name');                   
             #echo $restApiGET
             echo "jiraIssue_status=$restApiGET" >> $GITHUB_ENV
             
    - name: Display Status
      run: |
            echo ${{ env.jiraIssue_status }}
            
    - name: Update the Jira Issue with the GitHub Workflow ID
      run: |
            curl -D- -u nareg.karamanoukian@picsart.com:oBJTrxuI3qf0Do1MBpGbBE87 \
                 -X PUT --data "{ \"fields\": {\"customfield_10029\": \"$GITHUB_WORKFLOW_ID\" }}" \
                 -H "Content-Type: application/json" https://naregkar.atlassian.net/rest/api/3/issue/${{ env.jira_id }}

            
    - name: Assess the Status / To Do
      run: |
            returnedStatus=${{ env.jiraIssue_status }}
            echo 'returned status is: ' $returnedStatus
            if [ "$returnedStatus" = "Done" ]; then
              echo "Finished.. Success"
            else
              echo "Not finished"
              exit 1
            fi  
      
      
            
